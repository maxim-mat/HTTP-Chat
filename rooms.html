<!DOCTYPE HTML>
<html>
	<head>
		<title> Rooms </title>
		<script>
			
			var update = setInterval(getRooms, 1000);
            var currentRooms = [];
			
			function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }
			
			function newRoom(){
                if(currentRooms.indexOf(document.getElementById("roomInput").value) === -1){
                    currentRooms.push(document.getElementById("roomInput").value);
                    var base = '<root></root>';
                    var parser = new DOMParser();
                    var DOM = parser.parseFromString(base, "text/xml");
                    var room = DOM.createElement("room");
                    var id = DOM.createAttribute("name");
                    var elements = DOM.getElementsByTagName("root");
                    id.nodeValue = escapeHtml(document.getElementById("roomInput").value);
                    room.setAttributeNode(id);
                    elements[0].appendChild(room);
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "append", true);
                    xhttp.setRequestHeader("Content-type" , "application/xml");
                    xhttp.send(DOM);
                }
                document.getElementById("roomInput").value = '';
                return false;
            }
			
			function getRooms(){
				var xhttp = new XMLHttpRequest;
				xhttp.onreadystatechange = function(){
                    if(this.readyState == 4 && this.status == 200){
                        rooms = ''
                        var response = this.responseXML;
                            for(var i = 0; i < response.getElementsByTagName('room').length; i++){
                                rooms += '<button type="button" onclick="enterRoom(this.innerHTML)">' + response.getElementsByTagName('room')[i].childNodes[0].nodeValue + '</button><br>';
                            }
                        document.getElementById('rooms').innerHTML = rooms;
                    }
				}
				xhttp.open('GET', 'refresh', true);
				xhttp.send();
			}
            
            function enterRoom(name){
                window.open('/chat?room=$'.replace('$', name));
            }
			
		</script>
	</head>
	<body>
		<h1 align="center"><b> PyChat </b></h1><br/>
		<div id='rooms'></div><br>
		<form autocomplete='off' onsubmit='return newRoom()'>
			<input id='roomInput' name='name'><input type='submit' value='new room'>
		</form>
	</body>
</html>